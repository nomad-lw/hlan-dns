services:
  init-unbound:
    image: mvance/unbound:latest
    restart: "no"
    volumes:
      - ${PORTAINER_STACK_DIR:-.}/unbound:/opt/unbound/etc/unbound:ro
      - unbound-state:/opt/unbound/state
    entrypoint: >
      sh -c 'set -e;
      mkdir -p /opt/unbound/state;
      # Trust anchor
      unbound-anchor -a /opt/unbound/state/root.key -v || true;
      # Root hints
      if [ ! -s /opt/unbound/state/root.hints ]; then
        if command -v wget >/dev/null 2>&1; then
          wget -qO /opt/unbound/state/root.hints https://www.internic.net/domain/named.root || true;
        elif command -v curl >/dev/null 2>&1; then
          curl -fsSL https://www.internic.net/domain/named.root -o /opt/unbound/state/root.hints || true;
        elif [ -s /opt/unbound/etc/unbound/root.hints ]; then
          cp /opt/unbound/etc/unbound/root.hints /opt/unbound/state/root.hints || true;
        fi
      fi;
      # Remote-control certs
      cd /opt/unbound/state;
      [ -f unbound_control.key ] || unbound-control-setup'

  unbound:
    image: mvance/unbound:1.19.3
    container_name: unbound
    depends_on:
      - init-unbound
    command: >
      sh -c 'while [ ! -s /opt/unbound/state/root.key ] || [ ! -s /opt/unbound/state/root.hints ]; do sleep 1; done;
      unbound -d -c /opt/unbound/etc/unbound/unbound.conf'
    volumes:
      - ${PORTAINER_STACK_DIR:-.}/unbound:/opt/unbound/etc/unbound
      - unbound-state:/opt/unbound/state
    networks:
      default:
        ipv4_address: ${IP_UNBOUND}
    healthcheck:
      test: ["CMD", "drill", "-p", "5335", "@127.0.0.1", "cloudflare.com", "A"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  unbound-state:

networks:
  default:
    name: ${MACVLANNET}
    external: true
