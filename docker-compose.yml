services:
  init-unbound:
    image: mvance/unbound:1.19.3
    restart: "no"
    volumes:
      - ${PORTAINER_STACK_DIR:-.}/unbound:/opt/unbound/template:ro
      - unbound-data:/opt/unbound/etc/unbound
    entrypoint: |
      sh -c 'set -e;
      mkdir -p /opt/unbound/etc/unbound/state;
      if [ ! -f /opt/unbound/etc/unbound/unbound.conf ]; then
        cp /opt/unbound/template/unbound.conf /opt/unbound/etc/unbound/unbound.conf;
      fi;
      if [ -d /opt/unbound/template/conf.d ]; then
        find /opt/unbound/template/conf.d -type f -name "*.conf" -print0 | while IFS= read -r -d "" f; do
          rel="$${f#/opt/unbound/template/}";
          dest="/opt/unbound/etc/unbound/$${rel}";
          if [ ! -f "$${dest}" ]; then
            mkdir -p "$$(dirname "$${dest}")";
            cp "$${f}" "$${dest}";
          fi;
        done;
      fi;
      unbound-anchor -a /opt/unbound/etc/unbound/state/root.key -v || true;
      if [ ! -s /opt/unbound/etc/unbound/state/root.hints ]; then
        if command -v wget >/dev/null 2>&1; then
          wget -qO /opt/unbound/etc/unbound/state/root.hints https://www.internic.net/domain/named.root || true;
        elif command -v curl >/dev/null 2>&1; then
          curl -fsSL https://www.internic.net/domain/named.root -o /opt/unbound/etc/unbound/state/root.hints || true;
        elif [ -s /opt/unbound/template/root.hints ]; then
          cp /opt/unbound/template/root.hints /opt/unbound/etc/unbound/state/root.hints || true;
        fi;
      fi;
      rm -f /opt/unbound/etc/unbound/state/unbound_control.key /opt/unbound/etc/unbound/state/unbound_control.pem /opt/unbound/etc/unbound/state/unbound_server.key /opt/unbound/etc/unbound/state/unbound_server.pem 2>/dev/null || true;
      unbound-control-setup -d /opt/unbound/etc/unbound/state;
      UB_USER=_unbound;
      UB_GROUP=_unbound;
      if ! id -u "$$UB_USER" >/dev/null 2>&1; then
        if id -u unbound >/dev/null 2>&1; then
          UB_USER=unbound;
          UB_GROUP=unbound;
        else
          UB_USER=root;
          UB_GROUP=root;
        fi;
      fi;
      echo "Unbound service account: $${UB_USER}:$${UB_GROUP}";
      chown -R "$$UB_USER:$$UB_GROUP" /opt/unbound/etc/unbound/state || true;
      chmod 750 /opt/unbound/etc/unbound/state 2>/dev/null || true;
      chmod 640 /opt/unbound/etc/unbound/state/root.key 2>/dev/null || true;
      chmod 644 /opt/unbound/etc/unbound/state/root.hints 2>/dev/null || true;
      chmod 640 /opt/unbound/etc/unbound/state/unbound_* 2>/dev/null || true;
      echo "Init complete."'

  unbound:
    image: mvance/unbound:1.19.3
    container_name: unbound
    depends_on:
      - init-unbound
    volumes:
      - unbound-data:/opt/unbound/etc/unbound
    networks:
      default:
        ipv4_address: ${IP_UNBOUND}
    healthcheck:
      test: ["CMD", "drill", "-p", "5335", "@127.0.0.1", "cloudflare.com", "A"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  unbound-data:

networks:
  default:
    name: ${MACVLANNET}
    external: true
